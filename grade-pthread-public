#!/usr/bin/env python3

import os
import sys
import subprocess

TOTAL = 0
POSSIBLE = 0

def color(name, text):
    """Color text for terminal output."""
    colors = {"red": "\033[31m", "green": "\033[32m", "reset": "\033[0m"}
    if os.isatty(1):
        return colors.get(name, "") + text + colors["reset"]
    return text

def test(points, title):
    """Decorator for test functions."""
    def decorator(fn):
        def wrapper():
            global TOTAL, POSSIBLE
            POSSIBLE += points
            sys.stdout.write(f"== Test {title} == ")
            sys.stdout.flush()
            try:
                fn()
                if points:
                    print(f"{title}: {color('green', 'OK')}")
                TOTAL += points
            except AssertionError as e:
                if points:
                    print(f"{title}: {color('red', 'FAIL')}")
                print(f"    {e}")
        wrapper.fn = fn
        return wrapper
    return decorator

def run_test_case(test_num, n_value):
    """Run a single test case."""
    spec_file = f'tests/{test_num}_spec.json'
    input_file = f'tests/{test_num}.in'
    output_file = f'tests/{test_num}.out'
    answer_file = f'tests/{test_num}.ans'

    # Generate transformer
    ret = subprocess.call(
        f'python3 scripts/auto_gen_transformer.py --input {spec_file} --output transformer.cpp',
        shell=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL
    )
    if ret != 0:
        raise AssertionError(f'Failed to generate transformer')

    # Build
    ret = subprocess.call('make clean > /dev/null 2>&1 && make > /dev/null 2>&1', shell=True)
    if ret != 0:
        raise AssertionError(f'Build failed')

    # Run
    ret = subprocess.call(
        f'./main {n_value} {input_file} {output_file}',
        shell=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL
    )
    if ret != 0:
        raise AssertionError(f'Program execution failed')

    # Verify
    result = subprocess.run(
        f'python3 scripts/verify.py --output {output_file} --answer {answer_file}',
        shell=True, capture_output=True, text=True
    )

    if result.returncode != 0 or 'success' not in result.stdout.lower():
        raise AssertionError(f'Output verification failed')

@test(10, "test case 00")
def test_00():
    run_test_case('00', 200)

@test(10, "test case 01")
def test_01():
    run_test_case('01', 4000)

@test(0, "report")
def test_report():
    if not os.path.exists('pthreads-report.md'):
        raise AssertionError('pthreads-report.md not found')
    with open('pthreads-report.md') as f:
        if len(f.read().strip()) < 10:
            raise AssertionError('pthreads-report.md seems too short')
    print("OK")

if __name__ == '__main__':
    test_00()
    test_01()
    test_report()

    print(f"Score: {TOTAL}/{POSSIBLE}")

    if TOTAL < POSSIBLE:
        sys.exit(1)
